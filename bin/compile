#!/bin/bash -e
# bin/compile <build-dir> <cache-dir>

# Exit if any subcommand fails
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
CURRENT_DIR=$PWD

TRANSCRYPT_PASS_FILE="$ENV_DIR/TRANSCRYPT_PASS"

if [ ! -f $TRANSCRYPT_PASS_FILE ]; then
    printf "\n-----> ERROR: Please set TRANSCRYPT_PASS. You can get the password by running in your project directory: transcrypt --display \n\n"
    exit 1
fi

TRANSCRYPT_PASS=$(cat $TRANSCRYPT_PASS_FILE)

printf "\n-----> Successfully retrieved TRANSCRYPT_PASS from ENV var"

cd $BUILD_DIR

cat .gitattributes | \
grep "filter=crypt diff=crypt merge=crypt" | \
grep -v "^#" | \
sed 's/filter=crypt diff=crypt merge=crypt//;s/ //g' | \
tr '\n' '\0' | \
xargs -0 -I{} sh -c "echo '\n-----> Decrypting {}'; ENC_PASS=\"$TRANSCRYPT_PASS\" openssl enc -d -aes-256-cbc -md MD5 -pass env:ENC_PASS -a -in {} 2>/dev/null > {}.dec && mv {}.dec {}"

printf "\n-----> All transcrypted files decrypted!\n\n"
